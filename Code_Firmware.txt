char resultstr[64];
char levstr[64];
int id=314159265;


int ledOut = D0;
int breakIn = D1;
int breakLev = D2;
int ledLev = D3;

unsigned int start=0;
int val=LOW;
int valold=LOW;
int count = 0;
int lastcount = 0;

void setup() {

    Spark.variable("DripsPerMinute", &lastcount, INT);
    Spark.variable("result", &resultstr, STRING); 
    Spark.variable("level", &levstr, STRING);
    
    pinMode(ledOut, OUTPUT);
    pinMode(ledLev, OUTPUT);
    pinMode(breakIn, INPUT);
    pinMode(breakLev, INPUT);
    
}


void loop() {
    
 start = millis(); // take the start time
  count = 0; // reset counter
  // do the following loop for 60000ms = 1min
  while (millis()-start < 60000)
  {
     // check for overflow of millis()
     if (start > millis()) {
       start = millis();
       count = 0;
     }
    val = digitalRead(breakIn);
    if (val==LOW)
    {
      digitalWrite(ledOut, LOW);
    }
    else
    {
      digitalWrite(ledOut, HIGH);
      if (val!= valold) {
        count ++;
        valold = val;
      }
    }
    
    if (digitalRead(breakLev) == LOW)
    {
        digitalWrite(ledLev, HIGH);
        sprintf(levstr, "{\"Fluid Level too low?\":%d}", "YES");
    }
    else
    {
        digitalWrite(ledLev, LOW);
        sprintf(levstr, "{\"Fluid Level too low?\":%d}", "No");
    }
  }
  // 1 minute over. print conts
  Serial.print("Drips Per Minute : ");
  Serial.println(count,DEC);
  lastcount = count;

   // format data as JSON
    sprintf(resultstr, "{\"data1\":%d,\"data2\":%d}", id, lastcount); 

  
}    
